name: Close Generated File Dependabot PRs

on:
  workflow_dispatch:

jobs:
  close-prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Close dependabot PRs that only modify release.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Actions used in the generated release.yml
          GENERATED_ACTIONS="actions/checkout actions/upload-artifact actions/download-artifact"

          for action in $GENERATED_ACTIONS; do
            # Find open dependabot PRs for this action
            prs=$(gh pr list --repo "$GITHUB_REPOSITORY" --author "app/dependabot" --state open --json number,title,headRefName --jq ".[] | select(.title | contains(\"$action\")) | .number")

            for pr in $prs; do
              # Get files changed in this PR
              files=$(gh pr view "$pr" --repo "$GITHUB_REPOSITORY" --json files --jq '.files[].path')

              # Check if only release.yml is modified
              if [ "$files" = ".github/workflows/release.yml" ]; then
                echo "Closing PR #$pr - only modifies generated release.yml"
                gh pr close "$pr" --repo "$GITHUB_REPOSITORY" --comment "Closing: release.yml is auto-generated by cargo-dist. Run \`cargo dist generate\` to update action versions."
              else
                echo "Skipping PR #$pr - modifies files other than release.yml: $files"
              fi
            done
          done
